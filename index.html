
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loan App – Login</title>
  <link rel="stylesheet" href="./css/app.css" />
  <!-- ตั้งค่า Supabase ได้สองแบบ: แก้ใน js/supabase-config.js หรือใส่ meta -->
  <!-- <meta name="supabase-url"  content="https://YOUR-REF.supabase.co" /> -->
  <!-- <meta name="supabase-anon" content="YOUR-ANON-KEY" /> -->
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>Loan App</h1>
      <a class="btn" href="https://supabase.com/docs" target="_blank">Docs</a>
    </div>
    <div id="msg" class="alert hidden"></div>
    <div class="card">
      <h2>เข้าสู่ระบบ</h2>
      <div class="grid two">
        <div>
          <label>อีเมล</label>
          <input id="email" class="input" placeholder="you@email.com" />
        </div>
        <div>
          <label>รหัสผ่าน</label>
          <input id="password" class="input" type="password" placeholder="••••••••" />
        </div>
      </div>
      <div style="margin-top:14px" class="row">
        <button id="btn-login" class="btn primary">เข้าสู่ระบบ</button>
        <button id="btn-signup" class="btn">สมัครสมาชิก</button>
      </div>
      <p class="note" style="margin-top:10px">หากคุณเป็น admin จะถูกพาไปหน้าแอดมินอัตโนมัติ</p>
    </div>
    <div class="footer">© Loan App</div>
  </div>

  <script type="module">
    import './js/supabase-config.js';
    import './js/supabase-init.js';
    import Auth from './js/auth-manager.js';
    const $ = (s)=>document.querySelector(s);
    const msg = (t,ok=false)=>{ const m=$('#msg'); m.textContent=t; m.className='alert '+(ok?'ok':'err'); m.classList.remove('hidden'); };

    document.querySelector('#btn-login').addEventListener('click', async ()=>{
      try{
        const email = $('#email').value.trim();
        const pass  = $('#password').value.trim();
        const info = await Auth.signInWithPassword(email, pass);
        if(info.role==='admin') window.location.href='/admin/';
        else window.location.href='/loan/';
      }catch(e){ msg(e.message||String(e)); }
    });
    document.querySelector('#btn-signup').addEventListener('click', async ()=>{
      try{
        const email = $('#email').value.trim();
        const pass  = $('#password').value.trim();
        await Auth.signUp(email, pass);
        msg('สมัครสำเร็จ! โปรดยืนยันอีเมล (ถ้าตั้งค่าไว้) แล้วเข้าสู่ระบบ', true);
      }catch(e){ msg(e.message||String(e)); }
    });

    // ถ้า login อยู่แล้ว พาเข้าหน้าเหมาะสม
    (async ()=>{
      const info = await Auth.getUser();
      if(info){
        if(info.role==='admin') window.location.href='/admin/';
        else window.location.href='/loan/';
      }
    })();
  </script>
</body>
</html>
