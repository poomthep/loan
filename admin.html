<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Console - Loan App</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',sans-serif;line-height:1.5;color:#111;margin:0;background:#fafafa}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    a.button, button{display:inline-block;background:#2563eb;border:0;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer}
    a.button:hover, button:hover{background:#1e40af}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px}
    h1{font-size:22px;margin:0 0 6px}
    .muted{color:#6b7280;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-weight:600;font-size:14px}
    input[type="text"], input[type="number"], select, textarea{
      width:100%;padding:9px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff
    }
    textarea{min-height:80px}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb}
    thead th{background:#f3f4f6;font-weight:700;text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;font-size:14px;white-space:nowrap}
    tbody td{padding:10px;border-bottom:1px solid #f1f5f9;vertical-align:top;font-size:14px}
    .text-right{text-align:right}
    .actions{display:flex;gap:8px;justify-content:flex-end}
    .danger{background:#dc2626}
    .danger:hover{background:#991b1b}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:8px}
    .badge{border-radius:9999px;padding:3px 8px;font-size:12px;border:1px solid #e5e7eb;background:#f9fafb}
    .note{color:#6b7280;font-size:13px}
    .spacer{height:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="badge" id="role-badge">GUEST</div>
        <div class="muted">ผู้ใช้: <span id="user-email">—</span></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <a href="/" class="button" style="background:#111827">กลับหน้าแรก</a>
        <button id="btn-logout" style="display:none">ออกจากระบบ</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h1>จัดการโปรโมชัน (ข้อเสนอพิเศษและส่วนลด)</h1>
        <div class="muted">บันทึก/แก้ไขโปรโมชันของธนาคาร และค้นหาจากรายการด้านล่าง</div>

        <div class="spacer"></div>

        <div class="toolbar">
          <div class="note">ค้นหาหัวข้อ/รายละเอียด/ธนาคาร</div>
          <input id="admin-filter" type="text" placeholder="คำที่ต้องการค้นหา…" />
        </div>

        <div class="spacer"></div>

        <div style="overflow:auto">
          <table id="admin-promotions-table">
            <thead>
              <tr>
                <th>ธนาคาร</th>
                <th>ผลิตภัณฑ์</th>
                <th>ชื่อโปร</th>
                <th>รายละเอียด</th>
                <th class="text-right">ส่วนลด (bps)</th>
                <th class="text-right">คงที่ (%)</th>
                <th class="text-right">เดือนแรก</th>
                <th class="text-right">ปี1 (%)</th>
                <th class="text-right">จัดการ</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="9" class="text-right muted">กำลังโหลดข้อมูล…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="spacer"></div>

        <form id="admin-promo-form" class="grid">
          <div class="row">
            <div>
              <label for="admin-bank-select">ธนาคาร</label>
              <select id="admin-bank-select" name="bank_id" required>
                <option value="">เลือกธนาคาร</option>
              </select>
            </div>
            <div>
              <label for="admin-product-select">ผลิตภัณฑ์</label>
              <select id="admin-product-select" name="product_type">
                <option value="MORTGAGE" selected>MORTGAGE</option>
                <option value="HOME_EQUITY">HOME_EQUITY</option>
                <option value="OTHER">OTHER</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="admin-title">ชื่อโปรโมชัน</label>
              <input id="admin-title" name="title" type="text" placeholder="เช่น โปรดอกพิเศษ" required />
            </div>
            <div>
              <label for="admin-detail">รายละเอียด</label>
              <textarea id="admin-detail" name="detail" placeholder="รายละเอียดเงื่อนไข/หมายเหตุ"></textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="admin-bps">ส่วนลด (bps)</label>
              <input id="admin-bps" name="bps_discount" type="number" step="1" inputmode="numeric" />
            </div>
            <div>
              <label for="admin-fixed">อัตราคงที่ (%)</label>
              <input id="admin-fixed" name="fixed_rate" type="number" step="0.01" inputmode="decimal" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="admin-first-month">เดือนแรก</label>
              <input id="admin-first-month" name="first_month" type="number" step="1" inputmode="numeric" />
            </div>
            <div>
              <label for="admin-year-rate">ปี 1 (%)</label>
              <input id="admin-year-rate" name="year_rate" type="number" step="0.01" inputmode="decimal" />
            </div>
          </div>

          <div class="actions">
            <button id="btn-admin-delete" type="button" class="danger">ลบ</button>
            <button id="btn-admin-save" type="submit">บันทึก</button>
          </div>
        </form>

        <div class="spacer"></div>
        <div class="note">หมายเหตุ: ถ้ากด “แก้ไข” จากตารางด้านบน ฟอร์มนี้จะถูกกรอกให้โดยอัตโนมัติ</div>
      </section>
    </div>
  </div>

  <!-- === Scripts Order สำคัญมาก === -->
  <!-- 1) Supabase -->
  <script type="module" src="/supabase-init.js?v=1"></script>
  <!-- 2) ส่วนกลางของแอป -->
  <script defer src="/data-manager.js?v=1"></script>
  <!-- 3) จัดการล็อกอิน/สิทธิ์ -->
  <script defer src="/auth-manager.js?v=1"></script>

  <!-- 4) โหลดสคริปต์ Admin แบบลองหลายพาธอัตโนมัติ -->
  <script type="module">
    (async () => {
      const candidates = [
        '/admin-manager-supabase.module.js?v=1',
        '/js/admin-manager-supabase.module.js?v=1',
        './admin-manager-supabase.module.js?v=1',
        './js/admin-manager-supabase.module.js?v=1'
      ];
      let AdminManager = null;
      let lastError = null;

      for (const url of candidates) {
        try {
          const mod = await import(url);
          AdminManager = mod && (mod.default || mod.AdminManager);
          if (AdminManager) {
            window.AdminManager = AdminManager; // เผื่อโค้ดอื่นเรียกผ่าน global
            AdminManager.init();
            console.info('[Admin] Loaded from', url);
            break;
          }
        } catch (e) {
          lastError = e;
          console.debug('[Admin] try', url, '=>', e && e.message ? e.message : e);
        }
      }

      if (!AdminManager) {
        console.error('ไม่พบไฟล์ admin-manager-supabase.module.js ในตำแหน่งที่คาดไว้', lastError);
        alert('โหลดสคริปต์ผู้ดูแลไม่สำเร็จ: โปรดตรวจตำแหน่งไฟล์ admin-manager-supabase.module.js บนโฮสต์');
      }
    })();
  </script>
</body>
</html>
