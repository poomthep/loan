// js/auth-manager.js
// ========================================
// AUTHENTICATION MANAGER
// ========================================

import supabase, { handleSupabaseError } from './supabase-client.js';

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö Authentication ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
export class AuthManager {
  static currentUser = null;
  static userProfile = null;
  static authListeners = [];

  // ========================================
  // AUTHENTICATION METHODS
  // ========================================

  /**
   * ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
   */
  static async signInWithEmail(email, password) {
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.trim(),
        password: password
      });

      if (error) throw error;

      this.currentUser = data.user;
      await this.loadUserProfile();
      this.notifyAuthListeners('SIGNED_IN', data.user);

      console.log('‚úÖ Sign in successful:', data.user.email);
      return { success: true, user: data.user };

    } catch (error) {
      console.error('‚ùå Sign in error:', error);
      return { 
        success: false, 
        error: handleSupabaseError(error)
      };
    }
  }

  /**
   * ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà
   */
  static async signUp(email, password, userData = {}) {
    try {
      const { data, error } = await supabase.auth.signUp({
        email: email.trim(),
        password: password,
        options: {
          data: {
            full_name: userData.fullName || email.split('@')[0],
            ...userData
          }
        }
      });

      if (error) throw error;

      console.log('‚úÖ Sign up successful:', data.user?.email);
      return { 
        success: true, 
        user: data.user,
        needConfirmation: !data.session
      };

    } catch (error) {
      console.error('‚ùå Sign up error:', error);
      return { 
        success: false, 
        error: handleSupabaseError(error)
      };
    }
  }

  /**
   * ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
   */
  static async signOut() {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;

      this.currentUser = null;
      this.userProfile = null;
      this.notifyAuthListeners('SIGNED_OUT', null);

      console.log('‚úÖ Sign out successful');
      return { success: true };

    } catch (error) {
      console.error('‚ùå Sign out error:', error);
      return { 
        success: false, 
        error: handleSupabaseError(error)
      };
    }
  }

  /**
   * ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
   */
  static async resetPassword(email) {
    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email.trim(), {
        redirectTo: window.location.origin + '/reset-password'
      });

      if (error) throw error;

      console.log('‚úÖ Password reset email sent');
      return { success: true };

    } catch (error) {
      console.error('‚ùå Password reset error:', error);
      return { 
        success: false, 
        error: handleSupabaseError(error)
      };
    }
  }

  /**
   * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
   */
  static async updatePassword(newPassword) {
    try {
      const { error } = await supabase.auth.updateUser({
        password: newPassword
      });

      if (error) throw error;

      console.log('‚úÖ Password updated successfully');
      return { success: true };

    } catch (error) {
      console.error('‚ùå Password update error:', error);
      return { 
        success: false, 
        error: handleSupabaseError(error)
      };
    }
  }

  // ========================================
  // USER PROFILE METHODS
  // ========================================

  /**
   * ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
   */
  static async loadUserProfile() {
    if (!this.currentUser) return null;

    try {
      const { data, error } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('id', this.currentUser.id)
        .single();

      if (error && error.code !== 'PGRST116') { // PGRST116 = row not found
        throw error;
      }

      this.userProfile = data;
      return data;

    } catch (error) {
      console.error('Error loading user profile:', error);
      return null;
    }
  }

  /**
   * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
   */
  static async updateUserProfile(updates) {
    if (!this.currentUser) {
      throw new Error('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
    }

    try {
      const { data, error } = await supabase
        .from('user_profiles')
        .upsert({
  /**
   * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
   */
  static async updateUserProfile(updates) {
    if (!this.currentUser) {
      throw new Error('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
    }

    try {
      const { data, error } = await supabase
        .from('user_profiles')
        .upsert({
          id: this.currentUser.id,
          ...updates,
          updated_at: new Date().toISOString()
        })
        .select()
        .single();

      if (error) throw error;

      this.userProfile = data;
      this.notifyAuthListeners('PROFILE_UPDATED', data);

      console.log('‚úÖ Profile updated successfully');
      return { success: true, profile: data };

    } catch (error) {
      console.error('‚ùå Profile update error:', error);
      return { 
        success: false, 
        error: handleSupabaseError(error)
      };
    }
  }

  // ========================================
  // SESSION & STATE MANAGEMENT
  // ========================================

  /**
   * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
   */
  static async checkSession() {
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) throw error;

      if (session?.user) {
        this.currentUser = session.user;
        await this.loadUserProfile();
        this.notifyAuthListeners('SESSION_RESTORED', session.user);
        return session.user;
      }

      return null;

    } catch (error) {
      console.error('Error checking session:', error);
      return null;
    }
  }

  /**
   * ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á auth state
   */
  static setupAuthListener() {
    return supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('üîê Auth state changed:', event);

      switch (event) {
        case 'SIGNED_IN':
          this.currentUser = session?.user || null;
          if (this.currentUser) {
            await this.loadUserProfile();
          }
          this.notifyAuthListeners(event, session?.user);
          break;

        case 'SIGNED_OUT':
        case 'TOKEN_REFRESHED':
          this.currentUser = session?.user || null;
          this.userProfile = session?.user ? this.userProfile : null;
          this.notifyAuthListeners(event, session?.user);
          break;

        case 'PASSWORD_RECOVERY':
          this.notifyAuthListeners(event, session?.user);
          break;
      }
    });
  }

  /**
   * ‡πÄ‡∏û‡∏¥‡πà‡∏° listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á auth state
   */
  static addAuthListener(listener) {
    if (typeof listener === 'function') {
      this.authListeners.push(listener);
    }
  }

  /**
   * ‡∏•‡∏ö auth listener
   */
  static removeAuthListener(listener) {
    const index = this.authListeners.indexOf(listener);
    if (index > -1) {
      this.authListeners.splice(index, 1);
    }
  }

  /**
   * ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô listeners ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   */
  static notifyAuthListeners(event, user) {
    this.authListeners.forEach(listener => {
      try {
        listener(event, user, this.userProfile);
      } catch (error) {
        console.error('Error in auth listener:', error);
      }
    });
  }

  // ========================================
  // UTILITY METHODS
  // ========================================

  /**
   * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
   */
  static isAuthenticated() {
    return !!this.currentUser;
  }

  /**
   * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
   */
  static isAdmin() {
    return this.userProfile?.role === 'admin';
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
   */
  static getCurrentUser() {
    return this.currentUser;
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
   */
  static getUserProfile() {
    return this.userProfile;
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
   */
  static getFullUserData() {
    return {
      user: this.currentUser,
      profile: this.userProfile,
      isAuthenticated: this.isAuthenticated(),
      isAdmin: this.isAdmin()
    };
  }

  // ========================================
  // INITIALIZATION
  // ========================================

  /**
   * ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Auth Manager
   */
  static async initialize() {
    try {
      console.log('üöÄ Initializing Auth Manager...');

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
      await this.checkSession();

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ auth listener
      this.setupAuthListener();

      console.log('‚úÖ Auth Manager initialized successfully');
      return true;

    } catch (error) {
      console.error('‚ùå Auth Manager initialization failed:', error);
      return false;
    }
  }

  /**
   * ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   */
  static cleanup() {
    this.currentUser = null;
    this.userProfile = null;
    this.authListeners = [];
  }
}

// ========================================
// UI HELPER FUNCTIONS
// ========================================

/**
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏° auth state
 */
export function updateAuthUI() {
  const userData = AuthManager.getFullUserData();
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  const userEmailEl = document.getElementById('user-email');
  if (userEmailEl) {
    userEmailEl.textContent = userData.user?.email || '‚Äî';
  }

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï role badge
  const roleBadgeEl = document.getElementById('role-badge');
  if (roleBadgeEl) {
    if (userData.isAdmin) {
      roleBadgeEl.textContent = 'ADMIN';
      roleBadgeEl.className = 'badge px-2 py-1 rounded-full text-xs font-semibold bg-red-200 text-red-800';
    } else if (userData.isAuthenticated) {
      roleBadgeEl.textContent = 'USER';
      roleBadgeEl.className = 'badge px-2 py-1 rounded-full text-xs font-semibold bg-green-200 text-green-800';
    } else {
      roleBadgeEl.textContent = 'GUEST';
      roleBadgeEl.className = 'badge px-2 py-1 rounded-full text-xs font-semibold bg-gray-200';
    }
  }

  // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô login form
  const loginForm = document.getElementById('login-form');
  if (loginForm) {
    loginForm.style.display = userData.isAuthenticated ? 'none' : 'block';
  }

  // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° logout
  const logoutBtn = document.getElementById('btn-logout');
  if (logoutBtn) {
    logoutBtn.style.display = userData.isAuthenticated ? 'block' : 'none';
  }

  // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå admin (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ admin)
  const adminLinks = document.querySelectorAll('[href="/admin.html"]');
  adminLinks.forEach(link => {
    link.style.display = userData.isAdmin ? 'inline-block' : 'none';
  });
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ login form
 */
export function setupLoginForm() {
  const loginForm = document.querySelector('#login-form form');
  if (!loginForm) return;

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email')?.value;
    const password = document.getElementById('password')?.value;
    
    if (!email || !password) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
      return;
    }

    // ‡πÅ‡∏™‡∏î‡∏á loading
    const submitBtn = loginForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
    submitBtn.disabled = true;

    try {
      const result = await AuthManager.signInWithEmail(email, password);
      
      if (result.success) {
        // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        loginForm.reset();
        updateAuthUI();
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        
      } else {
        showNotification(result.error, 'error');
      }
    } catch (error) {
      showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° logout
 */
export function setupLogoutButton() {
  const logoutBtn = document.getElementById('btn-logout');
  if (!logoutBtn) return;

  logoutBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    
    const originalText = logoutBtn.textContent;
    logoutBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...';
    logoutBtn.disabled = true;

    try {
      const result = await AuthManager.signOut();
      
      if (result.success) {
        updateAuthUI();
        showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'info');
      } else {
        showNotification(result.error, 'error');
      }
    } catch (error) {
      showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'error');
    } finally {
      logoutBtn.textContent = originalText;
      logoutBtn.disabled = false;
    }
  });
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
 */
export function showNotification(message, type = 'info', duration = 3000) {
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á notification element
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  
  const colors = {
    success: 'bg-green-100 text-green-800 border-green-300',
    error: 'bg-red-100 text-red-800 border-red-300',
    info: 'bg-blue-100 text-blue-800 border-blue-300',
    warning: 'bg-yellow-100 text-yellow-800 border-yellow-300'
  };
  
  notification.className += ` ${colors[type] || colors.info} fixed top-4 right-4 px-4 py-2 rounded border z-50 max-w-sm`;
  notification.textContent = message;
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô DOM
  document.body.appendChild(notification);
  
  // ‡∏•‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
  setTimeout(() => {
    notification.remove();
  }, duration);
}

// ========================================
// AUTO INITIALIZATION
// ========================================

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Auth Manager ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
if (typeof window !== 'undefined') {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async () => {
      await AuthManager.initialize();
      updateAuthUI();
      setupLoginForm();
      setupLogoutButton();
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° auth listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï UI ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      AuthManager.addAuthListener(() => {
        updateAuthUI();
      });
    });
  } else {
    // ‡∏´‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
    (async () => {
      await AuthManager.initialize();
      updateAuthUI();
      setupLoginForm();
      setupLogoutButton();
      
      AuthManager.addAuthListener(() => {
        updateAuthUI();
      });
    })();
  }
}