<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>วิเคราะห์สินเชื่อ | Loan App</title>

  <style>
    :root{ --bg:#0b1220; --card:#121a2b; --text:#e6eefc; --muted:#94a3b8; --border:#1e2a44; --accent:#2eaadc;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Inter,Roboto,Arial}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .bar{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .btn{background:#1c2437;color:#e6eefc;border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:18px}
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left}
    .muted{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1 style="flex:1">วิเคราะห์สินเชื่อ</h1>
      <button class="btn" onclick="logout()">ออกจากระบบ</button>
    </div>

    <!-- placeholder เดิม -->
    <div class="card">
      <p>หน้านี้เป็น placeholder สำหรับคำนวณ/เปรียบเทียบสินเชื่อในอนาคต</p>
      <p class="muted">ผู้ใช้ทั่วไปและผู้ดูแลระบบเข้าถึงได้หลังล็อกอิน</p>
    </div>

    <!-- ✅ container ที่สคริปต์จะวาดเนื้อหา -->
    <div id="loan-content"></div>

    <footer class="muted">© Loan App</footer>
  </div>

  <!-- ลำดับโหลดแบบ Globals: init → data-manager → inline code -->
  <script src="/js/supabase-init.js"></script>
  <script src="/js/data-manager.js"></script>
  <script>
    // ป้องกัน “root เป็น null” และให้รันหลัง DOM พร้อม
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // ต้องล็อกอินก่อน
        const sess = await getSession();
        if (!sess) { location.assign('/'); return; }

        // หา/สร้าง container
        let root = document.getElementById('loan-content');
        if (!root) {
          console.warn('#loan-content not found; creating one.');
          root = document.createElement('div');
          root.id = 'loan-content';
          (document.querySelector('.wrap') || document.body).appendChild(root);
        }

        // ดึงข้อมูล
        const [promos, banks] = await Promise.all([
          DM.listPromotions(),
          DM.getBanks(),
        ]);
        const bankMap = Object.fromEntries(banks.map(b => [b.id, b.short_name || b.name]));

        // วาด UI (ถ้าไม่มีโปร)
        if (!promos || promos.length === 0) {
          root.innerHTML = `
            <div class="card">
              <h2>โปรโมชันที่ใช้งานอยู่</h2>
              <p class="muted">ยังไม่มีโปรโมชัน active</p>
            </div>`;
          return;
        }

        // ตารางโปร
        const rows = promos.map(p => `
          <tr>
            <td>${p.id}</td>
            <td>${bankMap[p.bank_id] || p.bank_id}</td>
            <td>${p.product_type || '-'}</td>
            <td>${p.title || '-'}</td>
            <td>${p.base || '-'}</td>
            <td>${p.y1 ?? ''}</td>
            <td>${p.y2 ?? ''}</td>
            <td>${p.y3 ?? ''}</td>
            <td>${p.active ? '✅' : '—'}</td>
          </tr>
        `).join('');

        root.innerHTML = `
          <div class="card">
            <h2>โปรโมชันที่ใช้งานอยู่</h2>
            <div style="overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th>ID</th><th>Bank</th><th>Product</th>
                    <th>Title</th><th>Base</th><th>Y1</th><th>Y2</th><th>Y3</th><th>Active</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>`;
      } catch (err) {
        console.error(err);
        const root = document.getElementById('loan-content') || (document.querySelector('.wrap') || document.body);
        root.insertAdjacentHTML('beforeend',
          `<div class="card"><p class="muted">โหลดข้อมูลผิดพลาด</p></div>`);
      }
    });
  </script>
</body>
</html>
