import {requireLogin,logout}from '../js/auth-manager.js';import {LoanCalculator}from '../js/loan-calculator-supabase.js';await requireLogin();const $=s=>document.querySelector(s);const calc=new LoanCalculator();const form=$('#loan-form');const resultTbody=$('#offers');const connBtn=$('#btn-check-conn');const logoutBtn=$('#btn-logout');connBtn?.addEventListener('click',async()=>{try{const {supabase}=await import('../js/supabase-init.js');await supabase.from('banks').select('id').limit(1);alert('เชื่อมต่อฐานข้อมูลได้')}catch(e){alert('เชื่อมต่อไม่ได้: '+e.message)}});logoutBtn?.addEventListener('click',()=>logout());form?.addEventListener('submit',async e=>{e.preventDefault();const p=readParams();const mode=document.querySelector('input[name="mode"]:checked')?.value||'max';const rows=mode==='max'?await calc.calculateMaxLoanAmount(p):await calc.checkLoanAmount(p);renderRows(rows,mode);await calc.saveCalculation(p,rows,mode)});function readParams(){const num=id=>parseFloat((document.getElementById(id)?.value||'0').replace(/,/g,''))||0;const int=id=>parseInt(document.getElementById(id)?.value||'0',10)||0;return{productType:document.getElementById('product')?.value||'MORTGAGE',income:num('income'),debt:num('debt'),incomeExtra:num('income-extra'),age:int('age'),years:int('years'),propertyValue:num('property'),propertyType:document.getElementById('property-type')?.value||null,homeNumber:int('home-number'),loanAmount:num('loan-amount')}}function renderRows(rows,mode){resultTbody.innerHTML='';if(!rows||!rows.length){resultTbody.innerHTML=`<tr><td colspan="8" class="center">ไม่พบข้อมูล</td></tr>`;return}for(const r of rows){const loanCol=mode==='max'?r.maxLoanAmount:r.loanAmount;const promo=r.promotion?`<div class="badge">${r.promotion.title}</div>`:'<span class="note">—</span>';const tr=document.createElement('tr');tr.innerHTML=`<td><strong>${r.bankShortName||'-'}</strong><div class="note">${r.bankName||''}</div></td><td>${promo}</td><td>${(r.interestRate||0).toFixed(2)}%</td><td>${fmt(r.monthlyPayment)}</td><td>${fmt(loanCol)}</td><td>${(r.dsr||0).toFixed(2)}%</td><td>${(r.ltv||0).toFixed(2)}%</td><td>${r.status==='APPROVED'?'✅ อนุมัติ':'❌ ไม่อนุมัติ'}</td>`;resultTbody.appendChild(tr)}}function fmt(n){return n==null?'—':new Intl.NumberFormat('th-TH').format(Math.round(n))}