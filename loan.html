<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loan Calculator & Comparison</title>
  <link rel="stylesheet" href="./app.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>
  <div class="container">
    <h1>üè† ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô</h1>
    <form id="loanForm" class="form-box">
      <label>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label><input id="salary" type="number" required />
      <label>‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ï‡πà‡∏≠‡∏õ‡∏µ:</label><input id="bonus" type="number" required />
      <label>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô:</label><input id="other_income" type="number" />
      <label>‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label><input id="debt" type="number" />
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ:</label><input id="desired_loan" type="number" required />
      <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤ DSR (%):</label><input id="dsr" type="number" value="40" />
      <label>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (%):</label><input id="rate" type="number" value="6.5" />
      <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏π‡πâ (‡∏õ‡∏µ):</label><input id="years" type="number" value="30" />
      <button type="submit" class="btn-primary">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</button>
    </form>

    <div id="result" class="result-box"></div>

    <h3>üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h3>
    <table id="compareTable">
      <thead>
        <tr><th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</th><th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏µ‡πÅ‡∏£‡∏Å</th><th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3 ‡∏õ‡∏µ</th><th>‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏õ‡∏µ‡πÅ‡∏£‡∏Å</th><th>‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3 ‡∏õ‡∏µ</th><th>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</th></tr>
      </thead><tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { getLoanCapacity, getInstallment, getPromotions, calculatePromotionInstallments } from "./src/js/loan-api.js";
    document.getElementById("loanForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const salary = parseFloat(document.getElementById("salary").value);
      const bonus = parseFloat(document.getElementById("bonus").value);
      const otherIncome = parseFloat(document.getElementById("other_income").value) || 0;
      const debt = parseFloat(document.getElementById("debt").value) || 0;
      const desiredLoan = parseFloat(document.getElementById("desired_loan").value);
      const dsr = parseFloat(document.getElementById("dsr").value) / 100;
      const rate = parseFloat(document.getElementById("rate").value);
      const years = parseInt(document.getElementById("years").value);
      try {
        const [capacity] = await getLoanCapacity(salary, bonus, otherIncome, debt, dsr, rate, years);
        const installmentMax = await getInstallment(capacity.loan_capacity, rate, years);
        const installmentDesired = await getInstallment(desiredLoan, rate, years);
        document.getElementById("result").innerHTML = `
          <p>üí∞ ‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <b>${capacity.loan_capacity.toFixed(0)} ‡∏ö‡∏≤‡∏ó</b></p>
          <p>üìä ‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î): <b>${installmentMax.toFixed(2)} ‡∏ö‡∏≤‡∏ó</b></p>
          <p>üìä ‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ ${desiredLoan}): <b>${installmentDesired.toFixed(2)} ‡∏ö‡∏≤‡∏ó</b></p>`;
        const promos = await getPromotions();
        const compare = await calculatePromotionInstallments(promos, desiredLoan, years);
        const best = compare.reduce((a, b) => (a.installmentAvg3y < b.installmentAvg3y ? a : b));
        const tbody = document.querySelector("#compareTable tbody");
        tbody.innerHTML = "";
        compare.forEach(row => {
          const tr = document.createElement("tr");
          if (row.bank === best.bank && row.promo_name === best.promo_name) { tr.classList.add("highlight"); }
          tr.innerHTML = `<td>${row.bank}</td><td>${row.promo_name}</td><td>${row.year1Rate.toFixed(2)}%</td>
            <td>${row.avg3yRate.toFixed(2)}%</td><td>${row.installmentYear1.toFixed(2)}</td>
            <td>${row.installmentAvg3y.toFixed(2)}</td><td>${row.conditions || "-"}</td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        document.getElementById("result").textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message;
      }
    });
  </script>
</body>
</html>
