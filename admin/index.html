<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>แอดมิน | Loan App</title>
  <link rel="stylesheet" href="../css/app.css">
</head>
<body>
  <div class="container">
    <div class="page-header between wrap">
      <h1>แผงควบคุมแอดมิน</h1>
      <div class="row gap">
        <a class="btn" href="../loan/">ไปหน้าคำนวณ</a>
        <button id="btn-logout" class="btn">ออกจากระบบ</button>
      </div>
    </div>

    <div class="card">
      <div class="row gap">
        <div class="stat-box"><div class="muted">ธนาคาร</div><div id="banks-total">—</div></div>
        <div class="stat-box"><div class="muted">โปรโมชัน (active)</div><div id="promos-total">—</div></div>
      </div>
    </div>

    <div class="card">
      <h3>รายการธนาคาร</h3>
      <div class="table-wrap"><table>
        <thead><tr><th>รหัส</th><th>ย่อ</th><th>ชื่อ</th></tr></thead>
        <tbody id="banks-body"><tr><td colspan="3" class="muted" style="text-align:center;padding:12px">กำลังโหลด...</td></tr></tbody>
      </table></div>
    </div>

    <div class="card">
      <h3>โปรโมชันที่ใช้งาน</h3>
      <div class="table-wrap"><table>
        <thead><tr><th>ID</th><th>Bank</th><th>Product</th><th>Title</th><th>Year1</th><th>Base+Spread</th></tr></thead>
        <tbody id="promos-body"><tr><td colspan="6" class="muted" style="text-align:center;padding:12px">กำลังโหลด...</td></tr></tbody>
      </table></div>
    </div>

    <div class="page-footer muted">© Loan App</div>
  </div>

  <script>
    window.__SUPABASE = {
      url: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtwc2ZlcndhcGxua3pyYnFvZ2h2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTI1NjUsImV4cCI6MjA3MTA4ODU2NX0.FizC7Ia92dqvbtfuU5T3hymh-UX6OEqQRvQnB0oY96Y",
      anonKey: "https://kpsferwaplnkzrbqoghv.supabase.co"
    };
  </script>
  <script type="module">
    import '../js/supabase-init.js';
    import AM, { requireAdmin } from '../js/auth-manager.js';
    import * as DM from '../js/data-manager.js';
    import './admin-manager-supabase.js'; // (optional enhance, not required)

    document.getElementById('btn-logout').addEventListener('click', async () => {
      await AM.signOut();
      window.location.href = '../index.html';
    });

    await requireAdmin({ redirectIfNoSession: '../index.html', redirectIfNotAdmin: '../loan/' });

    // โหลดข้อมูล
    const banks = await DM.getBanks();
    document.getElementById('banks-total').textContent = banks.length;
    const promos = await DM.getActivePromotions('MORTGAGE');
    document.getElementById('promos-total').textContent = promos.length;

    const banksBody = document.getElementById('banks-body');
    banksBody.innerHTML = banks.map(b => `<tr><td>${b.id}</td><td>${b.short_name||''}</td><td>${b.name||''}</td></tr>`).join('') || '<tr><td colspan="3" class="muted" style="text-align:center;padding:12px">—</td></tr>';

    const promosBody = document.getElementById('promos-body');
    promosBody.innerHTML = promos.map(p => `<tr><td>${p.id}</td><td>${p.bank_id}</td><td>${p.product_type}</td><td>${p.title||''}</td><td>${p.year1_rate ?? ''}</td><td>${(p.base_rate ?? '')}+${(p.spread ?? '')}</td></tr>`).join('') || '<tr><td colspan="6" class="muted" style="text-align:center;padding:12px">—</td></tr>';
  </script>
</body>
</html>
