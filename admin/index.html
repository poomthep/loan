<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>แผงควบคุมแอดมิน | Loan App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#8590a6; --text:#e6eefc; --accent:#2eaadc; --danger:#ef4444; --ok:#22c55e;
      --border:#1e2a44;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:1100px; margin:28px auto; padding:0 16px}
    h1{font-size:28px; margin:0 0 18px}
    .bar{display:flex; gap:12px; align-items:center; margin-bottom:18px}
    .btn{background:#1c2437; color:#e6eefc; border:1px solid var(--border); padding:9px 14px; border-radius:10px; cursor:pointer}
    .btn:hover{background:#222e49}
    .btn-primary{background:var(--accent); border-color:#199bcf}
    .btn-danger{background:#3a1217; border-color:#5c1b25; color:#fecaca}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:18px}
    .card h2{font-size:18px; margin:0 0 10px}
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border); padding:10px 8px; vertical-align:middle}
    th{font-weight:600; color:#c5d2ea; text-align:left}
    input,select,textarea{
      background:#0c1425; border:1px solid var(--border); color:var(--text); border-radius:10px;
      padding:9px 10px; outline:none; width:100%;
    }
    input:focus,select:focus,textarea:focus{border-color:#2d9ed6}
    .grid{display:grid; gap:12px}
    .grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .muted{color:var(--muted); font-size:12px}
    .badge{display:inline-block; font-size:12px; padding:2px 6px; border-radius:6px; border:1px solid var(--border); color:#c5d2ea}
    .row-actions{display:flex; gap:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1 style="flex:1">แผงควบคุมแอดมิน</h1>
      <button id="btn-logout" class="btn">ออกจากระบบ</button>
    </div>

    <!-- Banks -->
    <div class="card">
      <h2>ธนาคาร</h2>
      <p class="muted">ปรับค่า <strong>MRR</strong> เพื่อใช้อ้างอิงกับโปรที่ตั้งฐานดอกเบี้ยเป็น MRR</p>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:80px">ย่อ</th>
              <th>ชื่อ</th>
              <th style="width:140px">MRR</th>
              <th style="width:200px">มีผลตั้งแต่</th>
              <th style="width:120px"></th>
            </tr>
          </thead>
          <tbody id="banks-tbody">
            <tr><td colspan="5" class="muted">กำลังโหลด…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Promotions -->
    <div class="card">
      <h2>โปรโมชัน (active)</h2>

      <div class="grid grid-3" style="margin-bottom:10px">
        <div>
          <label class="muted">Bank</label>
          <select id="promo-bank"></select>
        </div>
        <div>
          <label class="muted">Product</label>
          <select id="promo-product">
            <option value="MORTGAGE">สินเชื่อบ้าน</option>
            <option value="REFINANCE">รีไฟแนนซ์</option>
            <option value="PERSONAL">ส่วนบุคคล</option>
            <option value="SME">SME</option>
          </select>
        </div>
        <div>
          <label class="muted">ชื่อโปร</label>
          <input id="promo-title" placeholder="เช่น โปรดอกพิเศษ 3.99" />
        </div>
      </div>

      <div class="grid grid-3" style="margin-bottom:10px">
        <div>
          <label class="muted">ฐานดอกเบี้ย</label>
          <select id="promo-base">
            <option value="">—</option>
            <option value="MRR">MRR</option>
            <option value="MLR">MLR</option>
            <option value="MOR">MOR</option>
          </select>
        </div>
        <div>
          <label class="muted">ปี 1 (%)</label>
          <input id="promo-y1" type="number" step="0.01" placeholder="3.99" />
        </div>
        <div>
          <label class="muted">ปี 2 (%)</label>
          <input id="promo-y2" type="number" step="0.01" />
        </div>
      </div>

      <div class="grid grid-3" style="margin-bottom:10px">
        <div>
          <label class="muted">ปี 3 (%)</label>
          <input id="promo-y3" type="number" step="0.01" />
        </div>
        <div style="display:flex; align-items:end; gap:10px">
          <label class="muted" style="display:flex; gap:8px; align-items:center">
            <input id="promo-active" type="checkbox" /> Active
          </label>
        </div>
        <div style="display:flex; align-items:end; justify-content:end; gap:8px">
          <button id="promo-save" class="btn btn-primary">บันทึกโปร</button>
        </div>
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:60px">ID</th>
              <th style="width:90px">Bank</th>
              <th style="width:130px">Product</th>
              <th>Title</th>
              <th style="width:100px">Base</th>
              <th style="width:80px">Y1</th>
              <th style="width:80px">Y2</th>
              <th style="width:80px">Y3</th>
              <th style="width:90px">Active</th>
              <th style="width:120px"></th>
            </tr>
          </thead>
          <tbody id="promos-tbody">
            <tr><td colspan="10" class="muted">กำลังโหลด…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- โมดูลหลัก (กัน cache ด้วย ?v=) + fallback รองรับ named/default export -->
  <script type="module">
	import * as AdminNS from '../js/admin-manager-supabase.js?v=20250901-5';  // เปลี่ยนเลข v เพื่อเคลียร์ cache
	const AdminManager = AdminNS.AdminManager || AdminNS.default;
    const am = new AdminManager();

    // --------- Utilities ---------
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    const fmt = (n, d=2) => (n ?? n === 0) ? Number(n).toFixed(d) : '';

    // --------- Banks ---------
    async function loadBanks() {
      const tbody = $('#banks-tbody');
      tbody.innerHTML = '<tr><td colspan="5" class="muted">กำลังโหลด…</td></tr>';
      try {
        const banks = await am.getBanks(); // [{id, short_name, name, mrr, mrr_effective_from}]
        if (!banks.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="muted">ไม่มีข้อมูล</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        for (const b of banks) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><span class="badge">${b.short_name || '-'}</span></td>
            <td>${b.name || '-'}</td>
            <td><input type="number" step="0.01" value="${b.mrr ?? ''}" data-bank="${b.id}" data-field="mrr" /></td>
            <td><input type="date" value="${(b.mrr_effective_from||'').slice(0,10)}" data-bank="${b.id}" data-field="date" /></td>
            <td class="row-actions">
              <button class="btn btn-primary btn-save" data-bank="${b.id}">บันทึก</button>
            </td>
          `;
          tbody.appendChild(tr);
        }

        // bind save per-row
        $$('.btn-save', tbody).forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const bankId = btn.dataset.bank;
            const row = btn.closest('tr');
            const mrr = parseFloat($('input[data-field="mrr"]', row).value || '0');
            const eff = $('input[data-field="date"]', row).value || null;
            btn.disabled = true;
            try {
              await am.updateBankMRR(bankId, mrr, eff);
              btn.textContent = '✔︎ บันทึกแล้ว';
              setTimeout(()=>btn.textContent='บันทึก', 1200);
            } catch (err) {
              console.error(err);
              btn.textContent = 'ผิดพลาด';
              btn.classList.add('btn-danger');
              setTimeout(()=>{
                btn.textContent='บันทึก';
                btn.classList.remove('btn-danger');
              }, 1500);
            } finally {
              btn.disabled = false;
            }
          });
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="5" class="muted">โหลดข้อมูลผิดพลาด</td></tr>';
      }
    }

    // --------- Promotions ---------
    let bankOptionsCache = [];

    function rebuildBankSelect() {
      const sel = $('#promo-bank');
      sel.innerHTML = '';
      for (const b of bankOptionsCache) {
        const opt = document.createElement('option');
        opt.value = b.id; opt.textContent = `${b.short_name || b.name || 'Bank'} (#${b.id})`;
        sel.appendChild(opt);
      }
    }

    async function loadPromotions() {
      const tbody = $('#promos-tbody');
      tbody.innerHTML = '<tr><td colspan="10" class="muted">กำลังโหลด…</td></tr>';
      try {
        const promos = await am.listPromotions();
        if (!promos.length) {
          tbody.innerHTML = '<tr><td colspan="10" class="muted">ไม่มีโปร active</td></tr>';
          return;
        }
        const bankMap = Object.fromEntries(bankOptionsCache.map(b => [b.id, b.short_name || b.name]));
        tbody.innerHTML = '';
        for (const p of promos) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.id}</td>
            <td>${bankMap[p.bank_id] || p.bank_id}</td>
            <td>${p.product_type || '-'}</td>
            <td>${p.title || '-'}</td>
            <td>${p.base || '-'}</td>
            <td>${fmt(p.year1 ?? null)}</td>
            <td>${fmt(p.year2 ?? null)}</td>
            <td>${fmt(p.year3 ?? null)}</td>
            <td>${p.active ? '✅' : '—'}</td>
            <td class="row-actions">
              <button class="btn btn-primary btn-edit" data-id="${p.id}">แก้ไข</button>
              <button class="btn btn-danger btn-del" data-id="${p.id}">ลบ</button>
            </td>
          `;
          tbody.appendChild(tr);
        }

        // bind edit / delete
        $$('.btn-edit', tbody).forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = Number(btn.dataset.id);
            const row = btn.closest('tr');
            // preload form จากแถว
            const bankShort = row.children[1].textContent.trim();
            const bank = bankOptionsCache.find(b => (b.short_name||b.name) === bankShort) || {};
            $('#promo-bank').value = bank.id || '';
            $('#promo-product').value = row.children[2].textContent.trim();
            $('#promo-title').value = row.children[3].textContent.trim();
            $('#promo-base').value = row.children[4].textContent.trim() || '';
            $('#promo-y1').value = row.children[5].textContent.trim();
            $('#promo-y2').value = row.children[6].textContent.trim();
            $('#promo-y3').value = row.children[7].textContent.trim();
            $('#promo-active').checked = row.children[8].textContent.includes('✅');
            $('#promo-save').dataset.editId = String(id);
            $('#promo-save').textContent = 'อัปเดตโปร';
          });
        });
        $$('.btn-del', tbody).forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = Number(btn.dataset.id);
            if (!confirm(`ลบโปรโมชัน #${id} ?`)) return;
            btn.disabled = true;
            try {
              await am.deletePromotion(id);
              await loadPromotions();
            } catch (err) {
              console.error(err);
              alert('ลบไม่สำเร็จ');
            } finally {
              btn.disabled = false;
            }
          });
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="10" class="muted">โหลดข้อมูลผิดพลาด</td></tr>';
      }
    }

    $('#promo-save').addEventListener('click', async ()=>{
      const payload = {
        id: $('#promo-save').dataset.editId ? Number($('#promo-save').dataset.editId) : undefined,
        bank_id: Number($('#promo-bank').value),
        product_type: $('#promo-product').value,
        title: $('#promo-title').value.trim(),
        base: $('#promo-base').value || null,
        year1: $('#promo-y1').value ? Number($('#promo-y1').value) : null,
        year2: $('#promo-y2').value ? Number($('#promo-y2').value) : null,
        year3: $('#promo-y3').value ? Number($('#promo-y3').value) : null,
        active: $('#promo-active').checked,
      };
      const btn = $('#promo-save');
      btn.disabled = true;
      try {
        await am.upsertPromotion(payload);
        // reset form
        btn.removeAttribute('data-edit-id');
        btn.textContent = 'บันทึกโปร';
        $('#promo-title').value = '';
        $('#promo-base').value = '';
        $('#promo-y1').value = '';
        $('#promo-y2').value = '';
        $('#promo-y3').value = '';
        $('#promo-active').checked = true;
        await loadPromotions();
      } catch (err) {
        console.error(err);
        alert('บันทึกโปรไม่สำเร็จ');
      } finally {
        btn.disabled = false;
      }
    });

    // --------- Logout (ถ้ามีระบบ auth) ---------
    $('#btn-logout').addEventListener('click', ()=>{
      // ถ้าใช้ supabase auth ให้เรียกผ่าน auth-manager.js ที่หน้า root
      // location.href = '/'; // แล้วแต่ระบบที่คุณใช้
      location.href = '/';
    });

    // --------- Bootstrap ---------
    (async () => {
      // โหลดธนาคารไว้ทำ options ของฟอร์มโปร
      try {
        bankOptionsCache = await am.getBanks();
        rebuildBankSelect();
      } catch(e){ console.error(e); }
      await loadBanks();
      await loadPromotions();
    })();
  </script>
</body>
</html>
